name: Monorepo Release

on:
  workflow_dispatch:
    inputs:
      tag_prefix:
        description: "聚合 tag 前缀（默认 @ziweijs/"
        required: false
        default: "@ziweijs/"
      dry_run:
        description: "仅演练（不推送 tag / 不发布 npm）"
        required: false
        default: "false"
      skip_tests:
        description: "跳过测试（紧急修复时使用）"
        required: false
        default: "false"

permissions:
  contents: write
  id-token: write

env:
  NODE_VERSION: "24"

jobs:
  release:
    name: Publish packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --force --tags

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        if: inputs.skip_tests != 'true'
        run: pnpm tsgo --noEmit

      - name: Run tests
        if: inputs.skip_tests != 'true'
        run: pnpm test

      - name: Build packages
        run: pnpm build

      - name: Generate release notes
        run: pnpm changeset status --output release-notes.md --verbose

      - name: Publish to npm
        if: inputs.dry_run != 'true'
        run: pnpm changeset publish

      - name: Push package tags
        if: inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git push --follow-tags

      - name: Compute aggregate tag
        id: aggregate_tag
        run: |
          PREFIX="${{ inputs.tag_prefix }}"
          if [ -z "$PREFIX" ]; then
            PREFIX="@ziweijs/ziwei"
          fi
          if [ -f packages/ziwei/package.json ]; then
            VERSION=$(jq -r '.version' packages/ziwei/package.json)
          else
            VERSION=$(jq -r '.version' package.json)
          fi
          TAG_NAME="$PREFIX@$VERSION"
          echo "name=$TAG_NAME" >> "$GITHUB_OUTPUT"

      - name: Create aggregate tag
        if: inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag -f "${{ steps.aggregate_tag.outputs.name }}"
          git push -f origin "${{ steps.aggregate_tag.outputs.name }}"

      - name: Create GitHub release
        if: inputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.aggregate_tag.outputs.name }}
          body_path: release-notes.md

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.md
